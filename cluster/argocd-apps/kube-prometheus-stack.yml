apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
spec:
  project: default
  source:
    # The prometheus-community Helm repo — one of the most widely used
    # Helm repos in the Kubernetes ecosystem.
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 72.*
    helm:
      # This chart has hundreds of configurable values.
      # These are tuned for a 2-node RPi cluster with limited RAM.
      # Full list: helm show values prometheus-community/kube-prometheus-stack
      values: |
        # --- Grafana ---
        grafana:
          enabled: true
          service:
            type: NodePort
            nodePort: 30030
          # Default login: admin / prom-operator
          adminPassword: prom-operator
          # Preloaded dashboards for cluster health, node stats, pod metrics
          defaultDashboardsEnabled: true
          defaultDashboardsTimezone: Europe/London

        # --- Prometheus ---
        prometheus:
          prometheusSpec:
            # Limit memory usage on RPi — default is much higher
            resources:
              requests:
                memory: 256Mi
                cpu: 100m
              limits:
                memory: 512Mi
            # How long to keep metrics data
            retention: 7d
            # Storage for metrics (uses local-path provisioner)
            storageSpec:
              volumeClaimTemplate:
                spec:
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 5Gi

        # --- Alertmanager ---
        # Disabled to save resources — you can enable it later
        # when you want to set up alert notifications
        alertmanager:
          enabled: false

        # --- Node Exporter ---
        # Collects hardware/OS metrics from each node (CPU, RAM, disk, temp)
        nodeExporter:
          enabled: true

        # --- Kube State Metrics ---
        # Collects metrics about Kubernetes objects (pods, deployments, etc.)
        kubeStateMetrics:
          enabled: true

        # --- Reduce resource usage for RPi ---
        prometheusOperator:
          resources:
            requests:
              memory: 128Mi
              cpu: 50m
            limits:
              memory: 256Mi
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      # Required for kube-prometheus-stack — it has CRDs that need
      # to be replaced rather than patched on upgrades
      - ServerSideApply=true
